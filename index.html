<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mac × Xcode Compatibility | Asteroid B612</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html {
            font-size: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
            position: relative;
            overflow-x: hidden;
        }

        /* Stars background */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.3;
            }

            50% {
                opacity: 1;
            }
        }

        /* Main container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Header section */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header .subtitle {
            font-size: 1.1rem;
            font-weight: 300;
            opacity: 0.9;
        }

        .header .quote {
            margin-top: 1rem;
            font-style: italic;
            opacity: 0.8;
            font-size: 0.95rem;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.8s ease-out;
            margin-bottom: 2rem;
        }

        /* Selection group */
        .selection-group {
            margin-bottom: 2rem;
        }

        .selection-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.8rem;
            color: #333;
            font-size: 1.1rem;
        }

        .selection-group select {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Quicksand', sans-serif;
        }

        .selection-group select:hover {
            border-color: #667eea;
        }

        .selection-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .pill-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .pill-button {
            border: 2px solid rgba(30, 64, 175, 0.6);
            background: rgba(13, 27, 62, 0.85);
            color: #e5edff;
            padding: 0.65rem 1.4rem;
            border-radius: 999px;
            cursor: pointer;
            font-family: 'Quicksand', sans-serif;
            font-weight: 600;
            transition: all 0.2s ease;
            letter-spacing: 0.01em;
        }

        .pill-button:hover {
            border-color: rgba(99, 102, 241, 0.9);
            color: #ffffff;
        }

        .pill-button.active {
            background: linear-gradient(135deg, #4f7dff 0%, #3355d8 100%);
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 6px 16px rgba(79, 125, 255, 0.35);
        }

        .pill-button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 125, 255, 0.4);
        }

        /* Button */
        .btn {
            width: 100%;
            padding: 1.2rem;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Result section */
        .result {
            margin-top: 2rem;
            padding: 2rem;
            border-radius: 15px;
            animation: slideIn 0.5s ease-out;
            text-align: center;
        }

        .result.compatible {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            border: 2px solid #667eea;
        }

        .result.incompatible {
            background: linear-gradient(135deg, #ff6b6b15, #ee5a6f15);
            border: 2px solid #ff6b6b;
        }

        .result .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .result h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .result.compatible h2 {
            color: #667eea;
        }

        .result.incompatible h2 {
            color: #ff6b6b;
        }

        .result .details {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: white;
            border-radius: 10px;
            text-align: left;
        }

        .result .details h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #555;
        }

        .result .details .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .result .details .info-row:last-child {
            border-bottom: none;
        }

        .result .details .label {
            font-weight: 500;
            color: #666;
        }

        .result .details .value {
            color: #333;
            font-weight: 600;
        }

        .sdk-list {
            margin-top: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.8rem;
        }

        .sdk-item {
            padding: 0.6rem;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
        }

        .sdk-item .platform {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.2rem;
        }

        .sdk-item .version {
            color: #666;
            font-size: 0.85rem;
        }

        /* Hidden element */
        .hidden {
            display: none;
        }

        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 1.5rem;
            }

            .sdk-list {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }

        /* Little Prince style decoration */
        .decoration {
            position: fixed;
            opacity: 0.1;
            pointer-events: none;
            z-index: 0;
        }

        .planet {
            position: fixed;
            bottom: -50px;
            right: -50px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3), transparent);
            border-radius: 50%;
            opacity: 0.2;
        }

        /* Loading animation */
        .loading {
            text-align: center;
            color: #667eea;
            padding: 2rem;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(3, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }
    </style>
</head>

<body>
    <!-- Stars background -->
    <div class="stars" id="stars"></div>

    <!-- Planet decoration -->
    <div class="planet"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🦊 Can Your Mac Tame Xcode?</h1>
            <div class="subtitle">A Tale of Taming on Asteroid B612</div>
            <div class="quote">"One only understands the things that one tames." — The Little Prince</div>
        </div>

        <!-- Main card -->
        <div class="card">
            <div class="selection-group">
                <label>💻 Select Mac Type</label>
                <div class="pill-group" id="macTypeGroup">
                    <button type="button" class="pill-button" data-mac-type="MacBook Air"
                        onclick="setMacType('MacBook Air')" aria-pressed="false">MacBook Air</button>
                    <button type="button" class="pill-button" data-mac-type="MacBook Pro"
                        onclick="setMacType('MacBook Pro')" aria-pressed="false">MacBook Pro</button>
                    <button type="button" class="pill-button" data-mac-type="iMac" onclick="setMacType('iMac')"
                        aria-pressed="false">iMac</button>
                    <button type="button" class="pill-button" data-mac-type="Mac Mini" onclick="setMacType('Mac Mini')"
                        aria-pressed="false">Mac Mini</button>
                </div>
            </div>

            <div class="selection-group">
                <label for="macYearSelect">📅 Select Year/Chip</label>
                <select id="macYearSelect" disabled>
                    <option value="">Choose a year/chip...</option>
                </select>
            </div>

            <div class="selection-group">
                <label for="macOSVersionInput">🍎 macOS Version (Optional)</label>
                <input type="text" id="macOSVersionInput" placeholder="e.g., 15.2, 14.5, 13.6"
                    style="padding: 0.75rem 1rem; border: 2px solid #e0e7ff; border-radius: 12px; font-size: 1rem; font-family: 'Quicksand', sans-serif; width: 100%; box-sizing: border-box; transition: all 0.3s ease;"
                    onfocus="this.style.borderColor='#667eea'; this.style.outline='none';"
                    onblur="this.style.borderColor='#e0e7ff';">
                <small style="color: #8b5cf6; font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    Leave empty to check all supported versions
                </small>
            </div>

            <div class="selection-group">
                <label for="xcodeSelect">🔨 Select Xcode Version</label>
                <select id="xcodeSelect">
                    <option value="">Choose an Xcode version...</option>
                </select>
            </div>

            <button class="btn" onclick="checkCompatibility()">
                🦊 Try to Tame
            </button>

            <!-- Result section -->
            <div id="result" class="hidden"></div>
        </div>
    </div>

    <script>
        let macOSData = [];
        let xcodeData = [];
        let selectedMacType = '';

        // Mac configurations (newest to oldest)
        const macConfigs = {
            'MacBook Air': ['M4', 'M3', 'M2', 'M1', '2020', '2019', '2018', '2017', '2016', '2015'],
            'MacBook Pro': ['M5', 'M4', 'M3', 'M2', 'M1', '2020', '2019', '2018', '2017', '2016', '2015'],
            'iMac': ['M4', 'M3', 'M1', '2020', '2019', '2018', '2017', '2016', '2015'],
            'Mac Mini': ['M4', 'M2', 'M1', '2018']
        };

        // Create stars
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        // Update year options based on selected Mac type
        function updateYearOptions() {
            const yearSelect = document.getElementById('macYearSelect');

            yearSelect.innerHTML = '<option value="">Choose a year/chip...</option>';
            yearSelect.value = '';

            if (!selectedMacType) {
                yearSelect.disabled = true;
                return;
            }

            const years = macConfigs[selectedMacType] || [];
            yearSelect.disabled = years.length === 0;

            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        function setMacType(macType, options = {}) {
            const force = options.force === true;
            const isAlreadySelected = selectedMacType === macType;
            const shouldClear = isAlreadySelected && !force;

            selectedMacType = shouldClear ? '' : macType;

            const buttons = document.querySelectorAll('#macTypeGroup .pill-button');
            buttons.forEach(btn => {
                const isActive = selectedMacType && btn.dataset.macType === selectedMacType;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            });

            updateYearOptions();

            const yearSelect = document.getElementById('macYearSelect');
            if (!force) {
                yearSelect.value = '';
            }
        }

        function applyDefaults() {
            setMacType('MacBook Pro', { force: true });

            const yearSelect = document.getElementById('macYearSelect');
            if (!yearSelect.disabled) {
                yearSelect.value = 'M5';
            }

            const xcodeSelect = document.getElementById('xcodeSelect');
            const hasDefaultXcode = Array.from(xcodeSelect.options).some(opt => opt.value === '26.1');
            if (hasDefaultXcode) {
                xcodeSelect.value = '26.1';
            }
        }

        // Convert user selection to match JSON format
        function getMacModelPattern(macType, year) {
            // Handle year-based models
            if (!isNaN(year)) {
                // For numeric years, we need to match patterns like "MacBook Air (2018 or later)"
                return `${macType} (${year}`;
            } else {
                // For chip-based models (M1, M2, etc.)
                return `${macType} (${year}`;
            }
        }

        // Load data
        async function loadData() {
            try {
                const [macResponse, xcodeResponse] = await Promise.all([
                    fetch('hardware_compatibility_os_supported.json'),
                    fetch('xcode_releases.json')
                ]);

                macOSData = await macResponse.json();
                xcodeData = await xcodeResponse.json();

                populateSelects();
                applyDefaults();
            } catch (error) {
                console.error('Failed to load data:', error);
                alert('Unable to load data. Please ensure JSON files exist.');
            }
        }

        // Populate select dropdowns
        function populateSelects() {
            const xcodeSelect = document.getElementById('xcodeSelect');

            // Populate Xcode versions
            xcodeData.forEach(xcode => {
                const option = document.createElement('option');
                option.value = xcode.xcode_version;
                option.textContent = `Xcode ${xcode.xcode_version}`;
                xcodeSelect.appendChild(option);
            });
        }

        // Version comparison functions
        function parseVersion(versionStr) {
            // Handle formats: "15.6+", "14.5 - 15.x", "14.x", etc.
            if (!versionStr) return null;

            if (versionStr.includes('+')) {
                // "15.6+" means >= 15.6
                const min = versionStr.replace('+', '').trim();
                return { type: 'min', min: min };
            } else if (versionStr.includes('-')) {
                // "14.5 - 15.x" means range
                const parts = versionStr.split('-').map(p => p.trim());
                return { type: 'range', min: parts[0], max: parts[1] };
            } else if (versionStr.includes('x')) {
                // "14.x" means 14.0 - 14.99
                const major = versionStr.replace('.x', '').trim();
                return { type: 'range', min: major + '.0', max: major + '.99' };
            } else {
                // Single version
                return { type: 'exact', version: versionStr };
            }
        }

        function compareVersions(v1, v2) {
            if (!v1 && !v2) return 0;
            if (!v1) return -1;
            if (!v2) return 1;

            // Convert version numbers to arrays for comparison
            const parts1 = v1.replace('x', '99').split('.').map(Number);
            const parts2 = v2.replace('x', '99').split('.').map(Number);

            for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                const p1 = parts1[i] || 0;
                const p2 = parts2[i] || 0;
                if (p1 > p2) return 1;
                if (p1 < p2) return -1;
            }
            return 0;
        }

        function extractMaxVersion(versionStr) {
            if (!versionStr) return null;
            const matches = versionStr.match(/\d+(?:\.\d+)?/g);
            if (!matches || matches.length === 0) {
                return null;
            }
            return matches.reduce((max, candidate) =>
                compareVersions(candidate, max) > 0 ? candidate : max
                , matches[0]);
        }

        function getLatestSupportedVersion(versions) {
            if (!versions || versions.length === 0) {
                return null;
            }
            let latest = null;
            versions.forEach(ver => {
                const candidate = extractMaxVersion(ver);
                if (!candidate) {
                    return;
                }
                if (!latest || compareVersions(candidate, latest) > 0) {
                    latest = candidate;
                }
            });
            return latest;
        }

        function isVersionInRange(macOS, xcodeRequirement) {
            // Validate inputs
            if (!macOS || !xcodeRequirement) return false;

            const macOSComparable = extractMaxVersion(macOS);
            if (!macOSComparable) return false;

            const req = parseVersion(xcodeRequirement);
            if (!req) return false;

            if (req.type === 'min') {
                // For minimum version requirements (e.g., "15.6+")
                // If Mac supports the same major version, it's compatible
                // because user can update to the required minor version
                const macOSMajor = macOSComparable.split('.')[0];
                const reqMajor = req.min.split('.')[0];

                // If major versions match, compatible (e.g., macOS 15 can update to 15.6)
                if (macOSMajor === reqMajor) {
                    return true;
                }

                // Otherwise check if macOS version is >= requirement
                return compareVersions(macOSComparable, req.min) >= 0;
            } else if (req.type === 'range') {
                // For range requirements (e.g., "15.2 - 15.x")
                // macOS cannot be downgraded, so we need exact range checking
                const macOSMajor = parseInt(macOSComparable.split('.')[0]);
                const minMajor = parseInt(req.min.split('.')[0]);
                const maxMajor = parseInt(req.max.replace('x', '99').split('.')[0]);

                // If major version is within range, check if user can upgrade to meet requirement
                // (e.g., macOS 15 can update to 15.2 for "15.2 - 15.x")
                if (macOSMajor === minMajor && macOSMajor === maxMajor) {
                    // Same major version - can upgrade within that version
                    return true;
                }

                // Check exact version range (for cross-major-version ranges like "14.5 - 15.x")
                const inRange = compareVersions(macOSComparable, req.min) >= 0 &&
                    compareVersions(macOSComparable, req.max) <= 0;

                // Also allow if macOS is in the same major version as the range
                // e.g., macOS 14 for "14.5 - 15.x" can be upgraded to 14.5
                const canUpgradeToMin = macOSMajor === minMajor;

                return inRange || canUpgradeToMin;
            } else if (req.type === 'exact') {
                return compareVersions(macOSComparable, req.version) === 0;
            }
            return false;
        }

        // Check if a Mac year/chip is compatible with a support string
        function isMacCompatible(macType, macYear, supportString) {
            // Check if it's the right Mac type
            if (!supportString.includes(macType)) {
                return false;
            }

            // Check for M-series chips
            if (macYear.startsWith('M')) {
                // M-series Macs: M1 (2020), M2 (2022), M3 (2023), M4 (2024), M5 (2025)
                const chipNumber = parseInt(macYear.substring(1));

                // Check for "M1 or later" pattern
                if (supportString.includes('M1 or later') || supportString.includes('M1,')) {
                    return true; // All M-series are compatible
                }

                // Check for specific M-series mention
                for (let i = 1; i <= chipNumber; i++) {
                    if (supportString.includes(`M${i}`)) {
                        return true;
                    }
                }

                // Check for year-based compatibility
                // M1: 2020, M2: 2022, M3: 2023, M4: 2024, M5: 2025
                const chipYearMap = { 'M1': 2020, 'M2': 2022, 'M3': 2023, 'M4': 2024, 'M5': 2025 };
                const macYearEquivalent = chipYearMap[macYear];

                // Extract year from "2018 or later" pattern
                const yearMatch = supportString.match(/\((\d{4}) or later\)/);
                if (yearMatch) {
                    const requiredYear = parseInt(yearMatch[1]);
                    return macYearEquivalent >= requiredYear;
                }

                // Extract specific year like "(2020)"
                const specificYearMatch = supportString.match(/\((\d{4})\)/);
                if (specificYearMatch && !supportString.includes('or later')) {
                    const specificYear = parseInt(specificYearMatch[1]);
                    return macYearEquivalent >= specificYear;
                }
            } else {
                // Numeric year
                const year = parseInt(macYear);

                // Check for exact match
                if (supportString.includes(`(${macYear})`)) {
                    return true;
                }

                // Check for "YYYY or later" pattern
                const yearMatch = supportString.match(/\(((?:Early|Mid|Late|Mid-Late|Late\s*Early)?\s*\d{4}) or later\)/i);
                if (yearMatch) {
                    const yearDigits = yearMatch[1].match(/\d{4}/);
                    if (yearDigits) {
                        const requiredYear = parseInt(yearDigits[0], 10);
                        return year >= requiredYear;
                    }
                }

                // Patterns like "MacBook Pro (Early 2015 or later)" without closing parenthesis grouping
                const qualifierMatch = supportString.match(/(Early|Mid|Late)\s+(\d{4}) or later/i);
                if (qualifierMatch) {
                    const requiredYear = parseInt(qualifierMatch[2], 10);
                    return year >= requiredYear;
                }
            }

            return false;
        }

        // Check compatibility
        function checkCompatibility() {
            const macType = selectedMacType;
            const macYear = document.getElementById('macYearSelect').value;
            const xcodeVersion = document.getElementById('xcodeSelect').value;
            const macOSVersionInput = document.getElementById('macOSVersionInput').value.trim();
            const resultDiv = document.getElementById('result');

            if (!macType || !macYear || !xcodeVersion) {
                alert('Please select Mac type, year/chip, and Xcode version');
                return;
            }

            // Find selected Xcode info
            const xcode = xcodeData.find(x => x.xcode_version === xcodeVersion);
            if (!xcode) {
                alert('Xcode information not found');
                return;
            }

            // Find all macOS versions that support this Mac
            const supportedMacOSVersions = [];

            macOSData.forEach(os => {
                os.supported_systems.forEach(mac => {
                    if (isMacCompatible(macType, macYear, mac)) {
                        if (!supportedMacOSVersions.includes(os.os)) {
                            supportedMacOSVersions.push(os.os);
                        }
                    }
                });
            });

            // Check compatibility
            let compatible = false;
            let userMacOSVersion = null;
            let canUpgradeToWork = false;
            let suggestedMacOSVersion = null;
            let maxSupportedMacOS = null;
            let recommendedXcode = null;

            if (macOSVersionInput) {
                // User specified a macOS version - check if it's supported by their Mac
                userMacOSVersion = macOSVersionInput;
                const isSupportedByMac = supportedMacOSVersions.some(supportedVer => {
                    const userMajor = userMacOSVersion.split('.')[0];
                    const supportedMajor = supportedVer.split('.')[0];
                    return userMajor === supportedMajor;
                });

                if (!isSupportedByMac) {
                    alert(`Warning: macOS ${userMacOSVersion} may not be supported by ${macType} (${macYear}). The Mac supports: ${supportedMacOSVersions.join(', ')}`);
                }

                // Check if user's macOS version meets Xcode requirements
                compatible = isVersionInRange(userMacOSVersion, xcode.macos_version);

                // If not compatible, check if upgrading macOS would help
                if (!compatible) {
                    // Parse Xcode requirements to get the range
                    const req = parseVersion(xcode.macos_version);

                    // Check if user can upgrade (not downgrade) to meet requirements
                    // For "15.6+" or "15.2 - 15.x", user's macOS should be <= the required range
                    let userCanUpgrade = false;

                    if (req.type === 'min') {
                        // For "15.6+", user can upgrade if their version is less than requirement
                        userCanUpgrade = compareVersions(userMacOSVersion, req.min) < 0;
                    } else if (req.type === 'range') {
                        // For "15.2 - 15.x", user can upgrade if they're below the range
                        // Cannot downgrade if user's version is above the max
                        const userMajor = parseInt(userMacOSVersion.split('.')[0]);
                        const maxMajor = parseInt(req.max.replace('x', '99').split('.')[0]);
                        userCanUpgrade = compareVersions(userMacOSVersion, req.max) <= 0;
                    } else if (req.type === 'exact') {
                        // For exact version, can upgrade if below
                        userCanUpgrade = compareVersions(userMacOSVersion, req.version) < 0;
                    }

                    // Check if any supported macOS version can work AND user can upgrade to it
                    if (userCanUpgrade) {
                        for (const supportedVer of supportedMacOSVersions) {
                            if (isVersionInRange(supportedVer, xcode.macos_version) &&
                                compareVersions(supportedVer, userMacOSVersion) >= 0) {
                                canUpgradeToWork = true;
                                break;
                            }
                        }
                    }

                    // If upgrading can work, determine the suggested version from Xcode requirements
                    if (canUpgradeToWork) {
                        if (req.type === 'min') {
                            // For "15.6+", suggest "15.6 or later"
                            suggestedMacOSVersion = req.min;
                        } else if (req.type === 'range') {
                            // For "15.2 - 15.x", suggest the minimum "15.2"
                            suggestedMacOSVersion = req.min;
                        } else if (req.type === 'exact') {
                            // For exact version like "14.x", use that
                            suggestedMacOSVersion = req.version;
                        }
                    } else {
                        // Cannot upgrade to work
                        // Check if user's macOS is newer than what Xcode supports
                        const userMacOSMajor = parseInt(userMacOSVersion.split('.')[0]);
                        let isUserMacOSTooNew = false;

                        if (req.type === 'range') {
                            const maxMajor = parseInt(req.max.replace('x', '99').split('.')[0]);
                            isUserMacOSTooNew = userMacOSMajor > maxMajor;
                        } else if (req.type === 'min') {
                            // For min type, user should never be "too new"
                            isUserMacOSTooNew = false;
                        } else if (req.type === 'exact') {
                            const reqMajor = parseInt(req.version.replace('x', '99').split('.')[0]);
                            isUserMacOSTooNew = userMacOSMajor > reqMajor;
                        }

                        if (isUserMacOSTooNew) {
                            // User's macOS is too new - find a newer Xcode that supports their macOS
                            for (const xcodeRelease of xcodeData) {
                                if (isVersionInRange(userMacOSVersion, xcodeRelease.macos_version)) {
                                    recommendedXcode = xcodeRelease.xcode_version;
                                    break; // xcodeData is sorted newest first
                                }
                            }
                        } else {
                            // Mac hardware is too old - find max supported macOS and compatible Xcode
                            maxSupportedMacOS = getLatestSupportedVersion(supportedMacOSVersions);

                            // Find the latest Xcode that works with max supported macOS
                            for (const xcodeRelease of xcodeData) {
                                if (isVersionInRange(maxSupportedMacOS, xcodeRelease.macos_version)) {
                                    recommendedXcode = xcodeRelease.xcode_version;
                                    break; // xcodeData is sorted newest first
                                }
                            }
                        }
                    }
                }
            } else {
                // No specific version - check if any supported macOS version meets Xcode requirements
                compatible = supportedMacOSVersions.some(macOS =>
                    isVersionInRange(macOS, xcode.macos_version)
                );

                // If not compatible, find max supported macOS and recommended Xcode for this Mac
                if (!compatible) {
                    maxSupportedMacOS = getLatestSupportedVersion(supportedMacOSVersions);

                    // Find the latest Xcode that works with max supported macOS
                    for (const xcodeRelease of xcodeData) {
                        if (isVersionInRange(maxSupportedMacOS, xcodeRelease.macos_version)) {
                            recommendedXcode = xcodeRelease.xcode_version;
                            break; // xcodeData is sorted newest first
                        }
                    }
                }
            }

            // Find compatible Mac models for this Xcode (when showing purchase recommendation)
            let compatibleMacs = [];
            if (!compatible && !canUpgradeToWork) {
                // Find which macOS versions support this Xcode
                const requiredMacOSVersions = macOSData.filter(os =>
                    isVersionInRange(os.os, xcode.macos_version)
                );

                // Extract supported Mac models from those macOS versions
                const macModelSet = new Set();
                requiredMacOSVersions.forEach(os => {
                    os.supported_systems.forEach(mac => {
                        macModelSet.add(mac);
                    });
                });

                compatibleMacs = Array.from(macModelSet);
            }

            const macModel = `${macType} (${macYear})`;
            displayResult(macModel, xcode, supportedMacOSVersions, compatible, userMacOSVersion, canUpgradeToWork, suggestedMacOSVersion, maxSupportedMacOS, recommendedXcode, compatibleMacs);
        }

        // Display result
        function displayResult(macModel, xcode, supportedMacOS, compatible, userMacOSVersion, canUpgradeToWork, suggestedMacOSVersion, maxSupportedMacOS, recommendedXcode, compatibleMacs) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result ' + (compatible ? 'compatible' : 'incompatible');

            const imageSrc = compatible ? 'tameOk.png' : 'tameFailed.png';
            const title = compatible ? '🎉 Successfully Tamed!' : '💔 Failed to Tame';
            const message = compatible
                ? `Your ${macModel} has successfully tamed Xcode ${xcode.xcode_version}!`
                : `Your ${macModel} cannot tame Xcode ${xcode.xcode_version}...`;

            let storyText = '';
            if (compatible) {
                storyText = `"You become responsible, forever, for what you have tamed." Your Mac and Xcode are now bonded!`;
            } else if (canUpgradeToWork) {
                storyText = `"It is only with the heart that one can see rightly." Your Mac can tame this Xcode by upgrading to macOS ${suggestedMacOSVersion} or later!`;
            } else {
                storyText = `"It is the time you have wasted for your rose that makes your rose so important." Perhaps it's time to upgrade your Mac?`;
            }

            let sdksHTML = '';
            if (Object.keys(xcode.sdks).length > 0) {
                sdksHTML = '<div class="sdk-list">';
                for (const [platform, version] of Object.entries(xcode.sdks)) {
                    sdksHTML += `
                        <div class="sdk-item">
                            <div class="platform">${platform}</div>
                            <div class="version">${version}</div>
                        </div>
                    `;
                }
                sdksHTML += '</div>';
            }

            // Show user's specific macOS version if provided
            const macOSVersionDisplay = userMacOSVersion
                ? `macOS ${userMacOSVersion}`
                : `macOS ${supportedMacOS.join(', ')}`;

            // Upgrade suggestion HTML
            let upgradeHTML = '';
            let isUserMacOSTooNew = false;
            if (!compatible) {
                const requirement = parseVersion(xcode.macos_version);

                if (canUpgradeToWork && userMacOSVersion && suggestedMacOSVersion && requirement) {
                    const upgradeMessage = requirement.type === 'exact'
                        ? `Your Mac can tame Xcode ${xcode.xcode_version} by upgrading to macOS ${suggestedMacOSVersion}.`
                        : `Your Mac can tame Xcode ${xcode.xcode_version} by upgrading to macOS ${suggestedMacOSVersion} or later.`;

                    upgradeHTML = `
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1rem; border-radius: 12px; margin: 1.5rem 0; border-left: 4px solid #f59e0b;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">💡</span>
                                <strong style="color: #92400e;">Good News!</strong>
                            </div>
                            <p style="color: #78350f; margin: 0; line-height: 1.6;">
                                ${upgradeMessage}
                            </p>
                        </div>
                    `;
                } else {
                    if (userMacOSVersion && requirement) {
                        const userMajor = parseInt(userMacOSVersion.split('.')[0], 10);

                        if (requirement.type === 'range') {
                            const maxMajor = parseInt(requirement.max.replace('x', '99').split('.')[0], 10);
                            isUserMacOSTooNew = userMajor > maxMajor;
                        } else if (requirement.type === 'exact') {
                            const reqMajor = parseInt(requirement.version.replace('x', '99').split('.')[0], 10);
                            isUserMacOSTooNew = userMajor > reqMajor;
                        }
                    }

                    let compatibleMacsHTML = '';
                    if (!isUserMacOSTooNew && compatibleMacs && compatibleMacs.length > 0) {
                        const macTypes = ['MacBook Air', 'MacBook Pro', 'iMac', 'Mac Mini'];
                        let macList = '';

                        macTypes.forEach(type => {
                            const matches = compatibleMacs.filter(mac => mac.startsWith(type));
                            if (matches.length === 0) {
                                return;
                            }

                            const descriptors = new Set();
                            matches.forEach(mac => {
                                const match = mac.match(/\(([^)]+)\)/);
                                if (match) {
                                    descriptors.add(match[1]);
                                }
                            });

                            if (descriptors.size > 0) {
                                macList += `<div style="margin: 0.25rem 0;"><strong>${type}:</strong> ${Array.from(descriptors).join(', ')}</div>`;
                            }
                        });

                        if (macList) {
                            compatibleMacsHTML = `
                                <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(254, 243, 199, 0.3); border-radius: 8px;">
                                    <div style="color: #78350f; margin-bottom: 0.5rem;"><strong>✅ Compatible Macs:</strong></div>
                                    <div style="color: #78350f; font-size: 0.9rem; line-height: 1.5;">
                                        ${macList}
                                    </div>
                                </div>
                            `;
                        }
                    }

                    const latestKnownMacOS = maxSupportedMacOS || (userMacOSVersion && !isUserMacOSTooNew ? userMacOSVersion : null);
                    let latestKnownXcode = recommendedXcode;

                    if (!latestKnownXcode && latestKnownMacOS) {
                        for (const xcodeRelease of xcodeData) {
                            if (isVersionInRange(latestKnownMacOS, xcodeRelease.macos_version)) {
                                latestKnownXcode = xcodeRelease.xcode_version;
                                break;
                            }
                        }
                    }

                    const renderSuggestion = (suggestion, index, total) => {
                        const label = total > 1 ? `Option ${index + 1}: ${suggestion.title}` : suggestion.title;
                        return `
                            <div style="background: rgba(254, 243, 199, 0.5); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <span style="font-size: 1.3rem;">${suggestion.icon}</span>
                                    <strong style="color: #92400e; font-size: 1.05rem;">${label}</strong>
                                </div>
                                ${suggestion.body}
                            </div>
                        `;
                    };

                    const suggestions = [];

                    if (!isUserMacOSTooNew) {
                        let body = '';
                        if (latestKnownMacOS || latestKnownXcode) {
                            const macOSText = latestKnownMacOS ? `macOS ${latestKnownMacOS}` : 'the latest macOS your Mac supports';
                            const xcodeText = latestKnownXcode ? `Xcode ${latestKnownXcode}` : 'a compatible Xcode release';
                            body = `
                                <p style="color: #78350f; margin: 0; line-height: 1.6;">
                                    Your ${macModel} runs best on <strong>${macOSText}</strong>. Pair it with <strong>${xcodeText}</strong> to keep developing today.
                                </p>
                            `;
                        } else {
                            body = `
                                <p style="color: #78350f; margin: 0; line-height: 1.6;">
                                    Download a macOS and Xcode pairing from Apple that supports your current hardware to continue your projects.
                                </p>
                            `;
                        }
                        suggestions.push({ icon: '🔧', title: 'Use Compatible Versions', body });
                    }

                    if (!isUserMacOSTooNew) {
                        const compatibleList = compatibleMacsHTML || `<p style="color: #78350f; margin: 0; line-height: 1.6;">Consider a recent Mac that ships with macOS ${xcode.macos_version} or newer.</p>`;
                        const body = `
                            <p style="color: #78350f; margin: 0 0 0.75rem 0; line-height: 1.6;">
                                To run Xcode ${xcode.xcode_version} with all features, pick a newer model:
                            </p>
                            ${compatibleList}
                        `;
                        suggestions.push({ icon: '🛍️', title: 'Upgrade Your Mac', body });
                    } else if (latestKnownXcode) {
                        const body = `
                            <p style="color: #78350f; margin: 0; line-height: 1.6;">
                                Xcode ${xcode.xcode_version} is outdated for macOS ${userMacOSVersion}. Try <strong>Xcode ${latestKnownXcode}</strong> or a newer release from Apple.
                            </p>
                        `;
                        suggestions.push({ icon: '🛍️', title: 'Install a Newer Xcode', body });
                    }

                    if (suggestions.length === 0) {
                        const body = `
                            <p style="color: #78350f; margin: 0; line-height: 1.6;">
                                Visit the Apple Developer downloads or consider newer hardware to unlock Xcode ${xcode.xcode_version} and later versions.
                            </p>
                        `;
                        suggestions.push({ icon: '🛍️', title: 'Upgrade Your Setup', body });
                    }

                    const suggestionHTML = suggestions
                        .map((suggestion, index) => renderSuggestion(suggestion, index, suggestions.length))
                        .join('');

                    upgradeHTML = `
                        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 1rem; border-radius: 12px; margin: 1.5rem 0; border-left: 4px solid #dc2626;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">⚠️</span>
                                <strong style="color: #7f1d1d;">Your Mac Cannot Tame This Xcode</strong>
                            </div>
                            <p style="color: #7f1d1d; margin: 0; line-height: 1.6;">
                                Your ${macModel} ${isUserMacOSTooNew ? `with macOS ${userMacOSVersion} is too new for` : 'cannot be upgraded to support'} Xcode ${xcode.xcode_version} (requires macOS ${xcode.macos_version}).
                            </p>
                            ${suggestionHTML}
                        </div>
                    `;
                }
            }

            resultDiv.innerHTML = `
                <img src="${imageSrc}" alt="${title}" style="max-width: 300px; width: 100%; height: auto; border-radius: 15px; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h2>${title}</h2>
                <p style="font-size: 1.1rem; margin-bottom: 1rem;">${message}</p>
                <p style="font-style: italic; opacity: 0.8; margin-bottom: 1.5rem;">${storyText}</p>
                ${upgradeHTML}
                    <div class="details">
                        <h3>📋 Taming Details</h3>
                        <div class="info-row">
                            <span class="label">Your Mac</span>
                            <span class="value">${macModel}</span>
                        </div>
                        ${userMacOSVersion ? `
                    <div class="info-row">
                        <span class="label">Your macOS Version</span>
                        <span class="value">macOS ${userMacOSVersion}</span>
                    </div>
                    ` : ''}
                        <div class="info-row">
                            <span class="label">Xcode to Tame</span>
                            <span class="value">${xcode.xcode_version}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Requires macOS</span>
                            <span class="value">${xcode.macos_version}</span>
                        </div>
                        ${!userMacOSVersion ? `
                    <div class="info-row">
                        <span class="label">Your Mac Supports</span>
                        <span class="value">macOS ${supportedMacOS.join(', ')}</span>
                    </div>
                    ` : ''}
                        ${!compatible && maxSupportedMacOS ? `
                    <div class="info-row" style="background: #fef3c7; padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem;">
                        <span class="label" style="color: #92400e;">📱 Latest macOS for Your Mac</span>
                        <span class="value" style="color: #92400e; font-weight: 700;">macOS ${maxSupportedMacOS}</span>
                    </div>
                    ` : ''}
                        ${!compatible && recommendedXcode ? `
                    <div class="info-row" style="background: #fef3c7; padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem;">
                        <span class="label" style="color: #92400e;">🔨 Latest Xcode for Your Mac</span>
                        <span class="value" style="color: #92400e; font-weight: 700;">Xcode ${recommendedXcode}</span>
                    </div>
                    ` : ''}
                    </div>
                    ${sdksHTML ? '<div style="margin-top: 1.5rem;"><h3>🛠️ Taming Tools (SDKs)</h3>' + sdksHTML + '</div>' : ''}
                </div>
            `;

            resultDiv.classList.remove('hidden');
        }

        // Initialize
        createStars();
        applyDefaults();
        loadData();
    </script>
</body>

</html>